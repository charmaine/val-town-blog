---
title: New HTTP Val Runtime in Preview
description: We built a new runtime for HTTP vals that is up to 5x faster at scale.
pubDate: July 17, 2024
author: Max McDonnell
---

We built a new runtime for HTTP vals that is much faster at scale. We've seen up to a 5x speedup for some vals. This is a preview feature, so expect rough edges. We'd love your feedback on it.

## Usage

We created a new val type – `HTTP (Preview)` – to let you opt-into the new runtime. Here's how:

1. Create a normal `HTTP` val
2. Click on the val's type `HTTP` and select `HTTP (Preview)` in the dropdown menu.

That's it! Run your val 5 times in quick succession to see the difference.

{/* Here's a simple script you can run to test it out yourself: TODO */}

{/* Or if you'd prefer, here's a utility website to do the same thing: TODO */}

## Architecture

Up till now, every time you run a val it starts a new Deno process and installs all your dependencies from scratch. This takes 100ms miliseconds at least, and can take much longer depending on how many dependencies you have.

With the new `HTTP (Preview)` val, we keep your Deno process around and forward multiple requests to it. This means that the first request will still have the 100ms+ cold start time, but every request after that will be _much_ faster. For example, the simplest posssible val that just returns "hello world!" will take 100ms to boot up the first time, but then only 10ms for subsequent requests. To be clear, that's not including network latency to the val (which from NYC, for example, is 90ms), just the time it takes for the val to respond.

So in summary, a user from NYC hitting a "hello world!" val will see a 180ms response time for the first request and 90ms for every request after that using `HTTP (Preview)`. With the normal `HTTP` val type, they would see 190ms for every request. The difference is even more pronounced for vals with more dependencies, particularly big ones or ones that boot up WASM. For example, we migrated the Date Me Directory to `HTTP (Preview)` and saw total requests time (from NYC) go from 800ms to 200ms!

There's one hitch in this story. We currently have 4 servers that run your HTTP vals. We are not yet smartly routing your requests to the server that has your val already running. This means that if you run a val 4 times in quick succession, you might hit 4 different servers, and each one will have to boot up your val from scratch. We are working on a smarter routing layer, but in the meantime, we recommend running your val 5 times in quick succession to correctly benchmark `HTTP (Preview)`.

We want to be conservative with this rollout, so we're only keeping `HTTP (Preview)` vals alive for 10 seconds after the end of the last request it receives. As we get more comfortable keeping vals alive for longer, we'll increase this timeout window, particularly for Pro users. We're considering ways to keep vals alive indefinitely, but that will require some changes to our pricing to make it sustainable.

## Limitations

There are currently two limitations to the `HTTP (Preview)` compared to the normal `HTTP` type:

1. It doesn't show `console.log` statements
2. It doesn't support cancelling any running executions

We expect to have fixes for these limitations in the next couple weeks. In the meantime, we recommend using the normal HTTP val type in development and then switching to HTTP (Preview) for production.

## Breaking changes

There is one breaking change with this new feature: it only re-runs your val handler, not any of the other code in your val. This means that if you have any code outside of your handler that you want to run on every request, you'll need to move it into your handler. This is how most serverless platforms work, and we think it's a good model to follow. You'll only need to migrate your code if you upgrade to the new runtime.

## Rollout

We intend for this new runtime to be the default `HTTP` val type going forward. So what is now `HTTP` will become `HTTP (Deprecated)`, and what is now `HTTP (Preview)` will become `HTTP`. There are two phases to the rollout:

1. **Preview** - `HTTP (Preview)` released to all users. This starts today, July 17th, 2024. You can opt-into `HTTP (Preview)` by changing your val type.
2. **Release** - All new `HTTP` vals will default to the new runtime. We plan for this to happen on August 1st, 2024. We will rename the val types accordingly:
   - What is now `HTTP (Preview)` will become `HTTP`
   - What is now `HTTP` will become `HTTP (Deprecated)`

We won't automatically upgrade `HTTP (Deprecated)` vals, because of the breaking change mentioned above. We'll let you manually opt-into the upgrade when you're ready.

## Feedback

We'd love to hear your feedback on this new feature. You can send a message in our `#general` or `#bugs` channels in [our Discord](https://discord.gg/dHv45uN5RY) or email us at [feedback@val.town](mailto:feedback@val.town).
